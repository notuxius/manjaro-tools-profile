#!/bin/bash

# TODO add checking of sed success completion
# https://unix.stackexchange.com/questions/88123/why-sed-does-not-return-exit-status-if-regex-does-not-matched?rq=1
    
sddm_conf_file=$(eval echo /etc/sddm.conf)
manjaro_live_map_file=$(eval echo /usr/share/manjaro-tools/desktop.map)
manjaro_live_sh_file=$(eval echo /usr/lib/manjaro-tools/util-live.sh)

err_text="Could not make modifications in Autorun section\nExiting...\n"
err_live_text="Could not make modifications in manjaro-live-base package files\n"

# overwrite setting of SDDM autologin - from Xorg plasma.desktop into Wayland session - in manjaro-live-base package files
if [ -w $manjaro_live_map_file ]; then
    sed -i 's|plasma:startkde|plasmawayland:startplasmacompositor|' $manjaro_live_map_file || { printf "$err_live_text";}
else
    printf "Manjaro tools desktop.map file cannot be written\nExiting...\n"
fi

if [ -w $manjaro_live_sh_file ]; then
    sed -i 's|xs=/usr/share/xsessions|xs=/usr/share/wayland-sessions|' $manjaro_live_sh_file || { printf "$err_live_text";}
else
    printf "Manjaro tools util-live.sh file cannot be written\nExiting...\n"
fi

if [ -w $sddm_conf_file ]; then
    # substitute any session with Wayland as a precaution
    sed -i 's/^Session=.*/Session=plasmawayland.desktop/' $sddm_conf_file || { printf "$err_text"; exit 1; }
    printf "Modified Session Autorun section\n"
    
    sed -i 's/^User=.*/User=netrunner/' $sddm_conf_file || { printf "$err_text"; exit 1; }
    printf "Modified User Autorun section\n"
    
    # ensure SDDM config file isn't modified by LiveMedia script at startup
    # chattr +i /etc/sddm.conf || { printf "$err_text"; exit 1; }
    # printf "Removed and locked write permission for SDDM config file\n"
else
    printf "SDDM configuration file cannot be written\nExiting...\n"
    exit 1
fi
